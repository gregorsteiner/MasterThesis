---
title: "Heatwaves"
author: "Gregor Steiner"
date: "`r format(Sys.Date(), format = '%m/%d/%Y')`"
output: pdf_document
bibliography: references.bib  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      fig.pos = "center",
                      fig.width = 8)
```


# Daily Weather Data

Using data provided by the Daily Global Historical Climatology Network [@Menne_2012], I identify extreme heat events in the historical temperature time series. Historical weather data is available for about 1200 measurement stations in the US. Based on the latitude and longitude coordinates I assign each station to the county it belongs to. In case there is more than one station per county, I take the mean among those.

Following the National Climate Data Center (NCDC), I define an extreme heat event as two or more consecutive days in which the minimum temperature exceeds the 85th percentile of July and August minimum temperatures [@Habeeb_2015]. 


```{r fig.cap="Minimum daily temperatures for selected counties (extreme heat events shaded in red)"}
# read data
data <- readRDS("WeatherDataCounty.RDS")

# Cosmetical Corrections
data <- within(data, {
  StateCounty <- sapply(strsplit(StateCounty, ","), function(x) paste0(toupper(x[2]), " COUNTY", ", ", toupper(x[1])))
  DATE <- as.Date(paste(YEAR, MONTH, DAY, sep = "-"))
})


# Define counties of interest
counties <- c("JACKSON COUNTY, OREGON", "ONTARIO COUNTY, NEW YORK",
             "ORANGE COUNTY, CALIFORNIA", "YORK COUNTY, SOUTH CAROLINA",
             "PIMA COUNTY, ARIZONA", "CHAMPAIGN COUNTY, ILLINOIS")



par(mfrow = c(round(length(counties) / 2), 2),
    mar = c(2, 4, 2, 1))
invisible(lapply(counties, function(x){
  
  dat <- data[data$StateCounty == x, ]
  
  # Indicate Heatwaves
  # compute threshold (85th percentile of july and august temperatures)
  bool.jul.aug <- dat$MONTH %in% c(7, 8) 
  threshhold <- quantile(dat[bool.jul.aug, "TMIN"], 0.85, na.rm = TRUE)
  
  # Mark as heatwave all consecutive days that exceed the threshhold
  bool <- dat[, "TMIN"] > threshhold
  bool <- ifelse(is.na(bool), FALSE, bool)
  dat$ExtremeHeatEvent <- 0
  
  for (i in 1:(nrow(dat)-1)) {
    if(all(bool[i:(i+1)])){
      dat[i:(i+1), "ExtremeHeatEvent"] <- 1
    }
  }
  
  # Get dates with extreme heat
  heatdates <- unlist(dat[dat$ExtremeHeatEvent == 1, "DATE"])
  
  # make graph
  plot(dat$DATE, dat$TMIN, type = "n",
       ylab = "Temperature in Â°C", xlab = "", main = x)
  
  abline(v = heatdates, col = rgb(1, 0, 0, 0.3), lwd = 1)
  lines(dat$DATE, dat$TMIN, lwd = 1)
  
  
}))



```





<!-- ```{r} -->
<!-- ########## Fatal Crash Data ########## -->
<!-- dat.crash <- haven::read_dta("20140100_indiv_records.dta") -->

<!-- # only keep relevant dates -->
<!-- dat.crash <- dat.crash[dat.crash$date >= as.Date("2003-01-01"), ] -->

<!-- # aggregate by county and state -->
<!-- crash.agg <- aggregate(list(Cases = dat.crash$st_case), -->
<!--                        by = list( -->
<!--                          Date = dat.crash$date, -->
<!--                          State = dat.crash$state, -->
<!--                          County = dat.crash$county -->
<!--                          ), -->
<!--                        FUN = length) -->
<!-- crash.agg <- crash.agg[order(crash.agg$State, crash.agg$County, crash.agg$Date), ] -->


<!-- ``` -->



# References



